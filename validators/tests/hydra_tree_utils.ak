use aiken/cbor
use hydra_dex/hydra_tree_utils.{compute_tree_hash, extract_key_values}
use hydra_dex/types.{Tree, TreeBranch, TreeLeaf}

const tree: Tree =
  TreeBranch {
    nibble: #"",
    nodes: [
      Pair(
        10,
        TreeBranch {
          nibble: #"",
          nodes: [
            Pair(
              4,
              TreeLeaf {
                path: #"a4328cf4f7a8d99af2d6183e29a5ef5ddeb2a9c885e3a1938a2676b9abf89709",
                key: #"d8799f505bade4195c2e4136b9bca9b563725eeed8799f581c979a51682aec06f704ab144bbb50aded23d63790caa174b0e33aa545ffd8799f581ce8fbeb1a29c4a9aead8b68614f1f0fead352160f6a5d9925a7a89841ffff",
                value: #"a140a1401864",
              },
            ),
            Pair(
              8,
              TreeLeaf {
                path: #"a8bff8ba4c3d1226e11931acea10974faa5d4a36f6d3952af85c4a15c9ed909d",
                key: #"d8799f505bade4195c2e4136b9bca9b563725cadd8799f581cfdeb4bf0e8c077114a4553f1e05395e9fb7114db177f02f7b65c8de4ffd8799f581cfd92839136c47054fda09f2fbbb1792386a3b143cea5fca14fb8baceffff",
                value: #"a1581c5066154a102ee037390c5236f78db23239b49c5748d3d349f3ccf04ba14455534458192710",
              },
            ),
          ],
        },
      ),
      Pair(
        15,
        TreeLeaf {
          path: #"f99beb2efeb35334b27c3ed37e4f5aa4ce89e57c07aa9f6c250fc2e2b59e7151",
          key: #"d8799f503450e8e7ff044148af0b0f151f490d99d8799f581c4ba6dd244255995969d2c05e323686bcbaba83b736e729941825d79bffd8799f581cec4574aacf96128597eff93ab9bc36c6bdc13d7f16ef5b62840ffa1fffff",
          value: #"a0",
        },
      ),
    ],
  }

const tree2: Tree = {
    expect Some(data_tree) =
      cbor.deserialise(
        #"d8799f40a500d87a9f582009430ca469c5b3271547e83bd073e3ec2a1d83531cd31b49f0815c950471bd525f5840d8799fd8799f5062ed242f1d9f436aa6609cccd04ef098d8799f581c04845038ee499ee8bc0afe56f688f27b2dd76f230d3698a9afcc1b66ffd8799f581c90f1581d47ac66119746cda54ec4afdaaaa56c09491d14c978a123835882ffffffff5832a240a1401a01c9c380581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1a01c9c380ff03d87a9f582036deaffc25ec36988a82a7c66a155357b1ff2cb540dd98e2038cb66a05782ef95f5840d8799fd8799f5061ed242f1d9f436aa6609cccd04ef098d8799f581c04845038ee499ee8bc0afe56f688f27b2dd76f230d3698a9afcc1b66ffd8799f581c90f1581d47ac66119746cda54ec4afdaaaa56c09491d14c978a123835882ffffffff5832a240a1401a01c9c380581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1a01c9c380ff0ad87a9f5820a80a13f6a9e371eb574ccf876364d20dfc76be9ee8dbaf380e06d8d5f09467e35f5840d8799fd8799f5064ed242f1d9f436aa6609cccd04ef098d8799f581c04845038ee499ee8bc0afe56f688f27b2dd76f230d3698a9afcc1b66ffd8799f581c90f1581d47ac66119746cda54ec4afdaaaa56c09491d14c978a123835882ffffffff5832a240a1401a01c9c380581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1a01c9c380ff0dd87a9f5820dd254ba4e15dd4969eb181cc407e77683638099105a18bac804107672b7659965f5840d8799fd8799f503fed242f1d9f436aa6609cccd04ef098d8799f581c04845038ee499ee8bc0afe56f688f27b2dd76f230d3698a9afcc1b66ffd8799f581c90f1581d47ac66119746cda54ec4afdaaaa56c09491d14c978a123835882ffffffff5832a240a1401a01c9c380581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1a01c9c380ff0ed87a9f5820e54a6b1d21e2e8b40be92b6b2bd660a78cb9f92c7b3d8285f095391e1da23a8b5f5840d8799fd8799f5063ed242f1d9f436aa6609cccd04ef098d8799f581c04845038ee499ee8bc0afe56f688f27b2dd76f230d3698a9afcc1b66ffd8799f581c90f1581d47ac66119746cda54ec4afdaaaa56c09491d14c978a123835882ffffffff5832a240a1401a01c9c380581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1a01c9c380ffff",
      )
    expect parsed_tree: Tree = data_tree
    parsed_tree
  }

test htu_compute_tree_hash() {
  compute_tree_hash(tree) == #"70bcce03913b9316f60c5e3d195dd19366333c64b12592e6a93a3e7fd130d86b"
}

test htu_compute_tree_hash2() {
  compute_tree_hash(tree2) == #"bee4ea1250a01a88f627211d503adbdf45e9fee8700d59c55bf90b54cd5edb18"
}

test htu_extract_key_values() {
  extract_key_values(tree) == [
    Pair(
      #"d8799f505bade4195c2e4136b9bca9b563725eeed8799f581c979a51682aec06f704ab144bbb50aded23d63790caa174b0e33aa545ffd8799f581ce8fbeb1a29c4a9aead8b68614f1f0fead352160f6a5d9925a7a89841ffff",
      #"a140a1401864",
    ),
    Pair(
      #"d8799f505bade4195c2e4136b9bca9b563725cadd8799f581cfdeb4bf0e8c077114a4553f1e05395e9fb7114db177f02f7b65c8de4ffd8799f581cfd92839136c47054fda09f2fbbb1792386a3b143cea5fca14fb8baceffff",
      #"a1581c5066154a102ee037390c5236f78db23239b49c5748d3d349f3ccf04ba14455534458192710",
    ),
    Pair(
      #"d8799f503450e8e7ff044148af0b0f151f490d99d8799f581c4ba6dd244255995969d2c05e323686bcbaba83b736e729941825d79bffd8799f581cec4574aacf96128597eff93ab9bc36c6bdc13d7f16ef5b62840ffa1fffff",
      #"a0",
    ),
  ]
}

test htu_extract_key_values2() {
  extract_key_values(tree2) == [
    Pair(
      #"d8799fd8799f5062ed242f1d9f436aa6609cccd04ef098d8799f581c04845038ee499ee8bc0afe56f688f27b2dd76f230d3698a9afcc1b66ffd8799f581c90f147ac66119746cda54ec4afdaaaa56c09491d14c978a123835882ffffff",
      #"a240a1401a01c9c380581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1a01c9c380",
    ),
    Pair(
      #"d8799fd8799f5061ed242f1d9f436aa6609cccd04ef098d8799f581c04845038ee499ee8bc0afe56f688f27b2dd76f230d3698a9afcc1b66ffd8799f581c90f147ac66119746cda54ec4afdaaaa56c09491d14c978a123835882ffffff",
      #"a240a1401a01c9c380581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1a01c9c380",
    ),
    Pair(
      #"d8799fd8799f5064ed242f1d9f436aa6609cccd04ef098d8799f581c04845038ee499ee8bc0afe56f688f27b2dd76f230d3698a9afcc1b66ffd8799f581c90f147ac66119746cda54ec4afdaaaa56c09491d14c978a123835882ffffff",
      #"a240a1401a01c9c380581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1a01c9c380",
    ),
    Pair(
      #"d8799fd8799f503fed242f1d9f436aa6609cccd04ef098d8799f581c04845038ee499ee8bc0afe56f688f27b2dd76f230d3698a9afcc1b66ffd8799f581c90f147ac66119746cda54ec4afdaaaa56c09491d14c978a123835882ffffff",
      #"a240a1401a01c9c380581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1a01c9c380",
    ),
    Pair(
      #"d8799fd8799f5063ed242f1d9f436aa6609cccd04ef098d8799f581c04845038ee499ee8bc0afe56f688f27b2dd76f230d3698a9afcc1b66ffd8799f581c90f147ac66119746cda54ec4afdaaaa56c09491d14c978a123835882ffffff",
      #"a240a1401a01c9c380581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1a01c9c380",
    ),
  ]
}

test htu_tree_cbor() {
  cbor.serialise(tree) == #"d8799f40a20ad8799f40a204d87a9f5820a4328cf4f7a8d99af2d6183e29a5ef5ddeb2a9c885e3a1938a2676b9abf897095f5840d8799f505bade4195c2e4136b9bca9b563725eeed8799f581c979a51682aec06f704ab144bbb50aded23d63790caa174b0e33aa545ffd8799f581ce8fbeb1a295819c4a9aead8b68614f1f0fead352160f6a5d9925a7a89841ffffff46a140a1401864ff08d87a9f5820a8bff8ba4c3d1226e11931acea10974faa5d4a36f6d3952af85c4a15c9ed909d5f5840d8799f505bade4195c2e4136b9bca9b563725cadd8799f581cfdeb4bf0e8c077114a4553f1e05395e9fb7114db177f02f7b65c8de4ffd8799f581cfd928391365819c47054fda09f2fbbb1792386a3b143cea5fca14fb8baceffffff5828a1581c5066154a102ee037390c5236f78db23239b49c5748d3d349f3ccf04ba14455534458192710ffff0fd87a9f5820f99beb2efeb35334b27c3ed37e4f5aa4ce89e57c07aa9f6c250fc2e2b59e71515f5840d8799f503450e8e7ff044148af0b0f151f490d99d8799f581c4ba6dd244255995969d2c05e323686bcbaba83b736e729941825d79bffd8799f581cec4574aacf581996128597eff93ab9bc36c6bdc13d7f16ef5b62840ffa1fffffff41a0ffff"
}
